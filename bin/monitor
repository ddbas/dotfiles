#!/usr/bin/env bash

help() {
  cat << EOF
usage: $0 [OPTIONS] <command>

    -h                    Show this message
EOF
}

OPTIND=1

FZF_BINDINGS=()

while getopts "hb:" opt;
do
  case "$opt" in
    h)
      help
      exit 0
      ;;
    b)
      FZF_BINDINGS+=("--bind=$OPTARG")
      ;;
  esac
done

shift $((OPTIND-1))

CMD=$@

reload_loop() {
    while true;
    do
        curl -XPOST localhost:6266 -d "reload($CMD)"
        sleep 5
    done
}

reload_loop &> /dev/null &
reload_loop_job=$!

$CMD | fzf --listen 6266 --layout reverse --ansi "${FZF_BINDINGS[@]}"

kill $reload_loop_job
